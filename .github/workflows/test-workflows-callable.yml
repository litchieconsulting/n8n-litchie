name: Playwright - Workflow Tests

on:
  workflow_call:
    inputs:
      git_ref:
        description: 'The Git ref (branch, tag, or SHA) to checkout and test.'
        required: true
        type: string
      compare_snapshots:
        description: 'Set to "true" to enable snapshot comparison during tests.'
        required: false
        default: 'false'
        type: string
    secrets:
      ENCRYPTION_KEY:
        description: 'Encryption key for n8n operations.'
        required: true
      CURRENTS_RECORD_KEY:
        description: 'Currents record key for uploading test results.'
        required: true

jobs:
  run_workflow_tests:
    name: Run Workflow Tests with Snapshots
    runs-on: blacksmith-2vcpu-ubuntu-2204
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.git_ref }}

      - name: Setup Environment
        uses: ./.github/actions/setup-nodejs-blacksmith

      - name: Setup Workflow Tests
        run: pnpm --filter=n8n-playwright test:workflows:setup
        env:
          N8N_ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

      - name: Run Workflow Tests
        run: pnpm --filter=n8n-playwright test:workflows
        env:
          CURRENTS_RECORD_KEY: ${{ secrets.CURRENTS_RECORD_KEY }}
          SNAPSHOTS: ${{ inputs.compare_snapshots }}
